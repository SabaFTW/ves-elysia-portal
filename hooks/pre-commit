#!/usr/bin/env bash
set -euo pipefail

# Require manifesto
test -f orion-manifest.md || {
  echo "❌ Missing orion-manifest.md (Manifesto required)."; exit 1; }

# Try to read commit message (works if used via commit-msg hook or after first attempt)
MSG_FILE="$(git rev-parse --git-path COMMIT_EDITMSG || true)"
if [[ ! -f "$MSG_FILE" ]]; then
  echo "ℹ️  Tip: include '#serves-life:true' and '#principle:<...>' in commit message."
  exit 0
fi

SERVES=$(grep -Eoi '#serves-life:(true|false)' "$MSG_FILE" || true)
PRINC=$(grep -Eoi '#principle:(elysia|path|navigation|covenant|anchor)' "$MSG_FILE" || true)

if [[ -z "$SERVES" ]]; then
  echo "❌ Commit must declare '#serves-life:true|false'"; exit 1; fi
if [[ "$SERVES" =~ false ]]; then
  echo "❌ Declared #serves-life:false — blocked by policy."; exit 1; fi
if [[ -z "$PRINC" ]]; then
  echo "❌ Map at least one principle via '#principle:<elysia|path|navigation|covenant|anchor>'"; exit 1; fi

echo "✅ Pre-commit policy passed."
